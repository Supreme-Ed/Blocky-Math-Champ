import { DirectionalLight, HemisphericLight, Vector3, MeshBuilder, StandardMaterial, Color3 } from '@babylonjs/core';

/**
 * Sets up all scene lighting: ambient hemispheric, dramatic sun, and visible sun mesh.
 * @param {BABYLON.Scene} scene
 */
export function importSceneLighting(scene) {
  // Subtle ambient light (hemispheric, low intensity)
  const hemiLight = new HemisphericLight("hemiLight", new Vector3(0, 1, 0), scene);
  scene._hemiLight = hemiLight;
  hemiLight.intensity = 0.30; // Reduced to make shadows more visible
  hemiLight.diffuse = new Color3(1, 1, 1);
  hemiLight.groundColor = new Color3(0, 0, 0);
  hemiLight.specular = new Color3(0, 0, 0);

  // Dramatic sun (directional light, positioned for better shadows)
  // Direction pointing down and slightly to the side for better shadows
  const sunDirection = new Vector3(-0.5, -1, -0.3).normalize();
  const sunLight = new DirectionalLight("sunLight", sunDirection, scene);
  scene._sunLight = sunLight;

  // Position the light closer to the scene for better shadows
  sunLight.position = new Vector3(20, 40, 20);
  sunLight.intensity = 1.5; // Balanced intensity
  sunLight.diffuse = new Color3(1, 1, 1);
  sunLight.specular = new Color3(1, 1, 1);

  // Shadow optimization settings
  sunLight.shadowMinZ = 1;
  sunLight.shadowMaxZ = 100; // Reduced for better precision
  sunLight.autoCalcShadowZBounds = false; // Manual control for debugging
  sunLight.autoUpdateExtends = true;

  // Optimize shadow frustum for directional light
  sunLight.shadowOrthoScale = 0.3; // Tighter shadow area for better quality
  sunLight.shadowFrustumSize = 50; // Smaller frustum for more precise shadows

  // Debug: Log light setup
  console.log("Sun light setup:", {
    direction: sunLight.direction,
    position: sunLight.position,
    intensity: sunLight.intensity,
    shadowMinZ: sunLight.shadowMinZ,
    shadowMaxZ: sunLight.shadowMaxZ,
    shadowOrthoScale: sunLight.shadowOrthoScale,
    shadowFrustumSize: sunLight.shadowFrustumSize
  });

  // Visible sun mesh in the sky
  const sunMesh = MeshBuilder.CreateSphere("sunMesh", { diameter: 12 }, scene);
  sunMesh.position = sunLight.position;
  const sunMat = new StandardMaterial("sunMat", scene);
  sunMat.emissiveColor = new Color3(1, 0.95, 0.6);
  sunMat.diffuseColor = new Color3(1, 1, 0.6);
  sunMat.specularColor = new Color3(0, 0, 0);
  sunMat.disableLighting = true;
  sunMesh.material = sunMat;
  sunMesh.isPickable = false;
  sunMesh.alwaysSelectAsActiveMesh = true;
}

/**
 * Creates a default hemispheric light for basic scene illumination.
 * @param {BABYLON.Scene} scene - The Babylon.js scene
 * @param {Object} [options]
 * @param {string} [options.name='light'] - Light name
 * @param {BABYLON.Vector3} [options.direction=new Vector3(0,1,0)] - Light direction
 * @param {number} [options.intensity=1.0] - Light intensity
 * @returns {BABYLON.HemisphericLight}
 */
export function createDefaultLight(scene, options = {}) {
  const { name = 'light', direction = new Vector3(0, 1, 0), intensity = 1.0 } = options;
  const light = new HemisphericLight(name, direction, scene);
  light.intensity = intensity;
  return light;
}

/**
 * Creates a directional light for shadows.
 * @param {BABYLON.Scene} scene - The Babylon.js scene
 * @param {Object} [options]
 * @param {string} [options.name='dirLight'] - Light name
 * @param {BABYLON.Vector3} [options.direction=new Vector3(0,-1,0)] - Light direction
 * @param {BABYLON.Vector3} [options.position=new Vector3(5,15,5)] - Light position
 * @param {number} [options.intensity=1.0] - Light intensity
 * @returns {BABYLON.DirectionalLight}
 */
export function createShadowLight(scene, options = {}) {
  const { name = 'dirLight', direction = new Vector3(-1, -2, -1), position = new Vector3(5, 15, 5), intensity = 1.0 } = options;
  const light = new DirectionalLight(name, direction, scene);
  light.position = position;
  light.intensity = intensity;
  return light;
}
